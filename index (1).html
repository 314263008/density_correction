<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Density Correction Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #5c5be5; --bg: #f0f2f9; --card: #ffffff; --dark-card: #121625; --success: #10b981; }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        header { background: var(--primary); color: white; padding: 20px 60px; display: flex; justify-content: space-between; align-items: center; }
        .logo-box { display: flex; align-items: center; gap: 15px; }
        .logo-icon { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px; font-size: 24px; }
        
        main { display: grid; grid-template-columns: 1fr 380px; gap: 30px; padding: 40px; max-width: 1300px; margin: auto; width: 100%; box-sizing: border-box; flex: 1; }
        .card { background: var(--card); border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card-title { color: var(--primary); font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; font-size: 18px; }
        label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; background: #fcfcfc; box-sizing: border-box; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        
        .energy-options-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 15px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; min-height: 50px; }
        .energy-pill { display: flex; align-items: center; gap: 6px; padding: 8px 12px; background: white; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .energy-pill:hover { border-color: var(--primary); color: var(--primary); }
        .energy-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        .yield-text { font-size: 11px; opacity: 0.7; }
        
        .slider-box { background: #f8faff; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .summary-card { background: var(--dark-card); color: white; border-radius: 24px; padding: 40px 30px; display: flex; flex-direction: column; gap: 35px; min-height: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .val-large { font-size: 48px; font-weight: 600; font-family: 'Courier New', monospace; color: #fff; }
        .val-medium { font-size: 32px; font-weight: bold; color: #00e676; }
        .error-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .error-val { font-size: 24px; font-weight: bold; color: #ff5252; }
        #file-drop { border: 2px dashed #cbd5e1; padding: 25px; border-radius: 16px; text-align: center; background: white; margin-bottom: 25px; cursor: pointer; transition: 0.3s; }

        /* Footer Ê®£Âºè */
        footer { background: var(--dark-card); color: rgba(255,255,255,0.6); padding: 40px 60px; font-size: 14px; border-top: 1px solid rgba(255,255,255,0.1); }
        .footer-content { max-width: 1300px; margin: auto; display: flex; justify-content: space-between; align-items: flex-start; }
        .footer-section { display: flex; flex-direction: column; gap: 10px; }
        .footer-title { color: white; font-weight: bold; margin-bottom: 5px; }
        .copyright { margin-top: 30px; text-align: center; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 20px; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <div class="logo-box">
        <div class="logo-icon">üß™</div>
        <div>
            <div style="font-size: 22px; font-weight: bold;">Density Correction Center</div>
            <div style="font-size: 12px; opacity: 0.8;">Gamma Spectroscopy Correction</div>
        </div>
    </div>
    <div style="text-align: right;">
        <div id="header-density" style="font-size: 20px; font-weight: bold;">œÅ = 1.0 g/cm¬≥</div>
    </div>
</header>

<main>
    <div class="left-col">
        <div id="file-drop" onclick="document.getElementById('fileInput').click()">
            <span id="file-name" style="color: #64748b;">Click to upload Excel (Required: "Â∑•‰ΩúË°®1")</span>
            <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
        </div>

        <div class="card">
            <div class="card-title">‚öôÔ∏è Primary Parameters</div>
            <div class="slider-box">
                <label>Sample Density (g/cm¬≥)</label>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 10px;">
                    <input type="range" id="densitySlider" min="0.3" max="2.2" step="0.1" value="1.0" 
                           oninput="syncInput(this.value); autoCalc();" style="flex: 1;">
                    <input type="number" id="densityNum" value="1.0" min="0.3" max="2.2" step="0.1" 
                           oninput="syncSlider(this.value); autoCalc();" 
                           onblur="validateDensity(this.value); autoCalc();"
                           style="width: 80px; border: 1px solid #ddd; border-radius: 6px; padding: 4px 8px; font-size: 16px; font-weight: bold; color: var(--primary); text-align: center;">
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; font-weight: bold;">
                    <span>0.3 MIN</span>
                    <span>1.0 STD</span>
                    <span>2.2 MAX</span>
                </div>
            </div>

            <div class="form-row">
                <div>
                    <label>Select Isotope (Ê†∏Á®Æ)</label>
                    <select id="isotopeSelect" onchange="updateEnergyOptions();">
                        <option>Wait for file...</option>
                    </select>
                </div>
                <div>
                    <label>Selected Gamma Energies (keV)</label>
                    <div id="energyOptions" class="energy-options-container">
                        <span style="color:#aaa; font-size:12px;">Choose isotope first...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìä Validation & Analysis</div>
            <div class="form-row">
                <div><label>Measured Activity (Bq/kg)</label><input type="number" id="measuredVal" oninput="autoCalc()" placeholder="e.g. 125.4"></div>
                <div><label>Ground Truth (Bq/kg)</label><input type="number" id="trueVal" oninput="autoCalc()" placeholder="e.g. 120.0"></div>
            </div>
        </div>
    </div>

    <div class="right-col">
        <div class="summary-card">
            <div id="init-view" style="text-align:center; margin-top:80px; color:#8e94aa;">
                <p>Waiting for data...</p>
                <p style="font-size: 12px;">Ë´ã‰∏äÂÇ≥Ê™îÊ°à‰∏¶ÈÅ∏ÊìáËÉΩÈáèËàáËº∏ÂÖ•Êï∏ÂÄº</p>
            </div>
            <div id="result-view" style="display: none;">
                <div class="sum-label">Weighted Factor (C<sub>d</sub>)</div>
                <div class="val-large" id="res-cd">1.000000</div>
                <div style="margin: 30px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
                <div class="sum-label">Corrected Activity</div>
                <div class="val-medium" id="res-activity">0.00</div>
                <div class="error-container" style="margin-top: 40px;">
                    <div class="sum-label" style="margin-bottom: 10px; opacity: 0.7;">Percentage Error</div>
                    <div class="error-val" id="res-error">0.00%</div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <div class="footer-title">ÈóúÊñºÁ≥ªÁµ±</div>
            <span>Gamma Â∞ÑÁ∑öÂàÜÊûêÂØÜÂ∫¶Ê†°Ê≠£Â∑•ÂÖ∑</span>
            <span>ÁâàÊú¨Ôºöv1.2.0 (2026 Build)</span>
        </div>
        <div class="footer-section">
            <div class="footer-title">ÊäÄË°ìÊîØÊè¥</div>
            <a href="https://gemini.google.com" target="_blank">https://gemini.google.com</a>
        </div>
        <div class="footer-section">
            <div class="footer-title">‰ΩøÁî®Ë¶èÁØÑ</div>
            <span>ÂÉÖ‰æõÂ≠∏Ë°ì‰∫§ÊµÅ‰ΩøÁî®Ôºå‰∏çÂèØÁßÅËá™Ë≤©ÂîÆ</span>
        </div>
    </div>
    <div class="copyright">
        ¬© 2026 Density Correction Center. All rights reserved. 
    </div>
</footer>

<script>
    let rawData = [];
    let selectedEnergies = new Set();
    let idxEnergy, idxYield, idxIsotope;

    // --- ÂØÜÂ∫¶ÊªëÊ°øÂêåÊ≠•ÈÇèËºØ (123(1) ÈÇèËºØ) ---
    function syncInput(val) {
        const n = parseFloat(val);
        const fixedVal = n.toFixed(1); 
        document.getElementById('densityNum').value = fixedVal;
        document.getElementById('header-density').innerText = `œÅ = ${fixedVal} g/cm¬≥`;
    }

    function syncSlider(val) {
        if (val === "") return;
        let n = parseFloat(val);
        if (n >= 0.3 && n <= 2.2) {
            document.getElementById('densitySlider').value = n;
        }
    }

    function validateDensity(val) {
        let n = parseFloat(val);
        if (isNaN(n) || n < 0.3) n = 0.3;
        if (n > 2.2) n = 2.2;
        const finalVal = (Math.round(n * 10) / 10).toFixed(1);
        document.getElementById('densityNum').value = finalVal;
        document.getElementById('densitySlider').value = finalVal;
        document.getElementById('header-density').innerText = `œÅ = ${finalVal} g/cm¬≥`;
    }

    // --- Ê™îÊ°àËÆÄÂèñ ---
    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        const dropZone = document.getElementById('file-drop');
        const fileNameDisplay = document.getElementById('file-name');

        reader.onload = (event) => {
            const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
            const sheet = workbook.Sheets["Â∑•‰ΩúË°®1"];
            if(!sheet) return alert("Êâæ‰∏çÂà∞ 'Â∑•‰ΩúË°®1'");
            
            rawData = XLSX.utils.sheet_to_json(sheet, {header: 1});
            const headerRow = rawData[1];
            idxEnergy = headerRow.indexOf("ËÉΩÈáèÁØÑÂúç(keV)");
            idxYield = headerRow.indexOf("gamma rayÂç†ÊØî");
            idxIsotope = headerRow.indexOf("Ê†∏Á®Æ");

            if (idxEnergy === -1 || idxYield === -1 || idxIsotope === -1) {
                return alert("Excel Ê®ôÈ°å‰∏çÊ≠£Á¢∫ÔºåË´ãÊ™¢Êü•ÂêçÁ®±ÊòØÂê¶ÂÆåÂÖ®Á¨¶Âêà„ÄÇ");
            }

            const isotopes = [...new Set(rawData.slice(2).map(r => r[idxIsotope]))].filter(Boolean);
            document.getElementById('isotopeSelect').innerHTML = isotopes.map(i => `<option value="${i}">${i}</option>`).join('');
            
            fileNameDisplay.innerText = `‚úÖ Â∑≤ÊàêÂäüËºâÂÖ•Ôºö${file.name}`;
            fileNameDisplay.style.color = "#10b981";
            dropZone.style.borderColor = "#10b981";
            dropZone.style.background = "#f0fdf4";
            
            updateEnergyOptions();
            alert("Ê™îÊ°à‰∏äÂÇ≥ÊàêÂäüÔºÅ");
        };
        reader.readAsArrayBuffer(file);
    };

    function updateEnergyOptions() {
        const iso = document.getElementById('isotopeSelect').value;
        const container = document.getElementById('energyOptions');
        selectedEnergies.clear();
        const options = rawData.slice(2).filter(r => String(r[idxIsotope]).trim() === iso);
        container.innerHTML = options.map(r => {
            const energy = r[idxEnergy];
            const yieldVal = (parseFloat(r[idxYield]) * 100).toFixed(1);
            return `<div class="energy-pill" onclick="toggleEnergy(this, ${energy})">${energy} <span class="yield-text">(${yieldVal}%)</span></div>`;
        }).join('');
        autoCalc(); 
    }

    function toggleEnergy(el, energy) {
        if(selectedEnergies.has(energy)) {
            selectedEnergies.delete(energy);
            el.classList.remove('active');
        } else {
            selectedEnergies.add(energy);
            el.classList.add('active');
        }
        autoCalc(); 
    }

    // --- Ëá™ÂãïÈÅãÁÆó ---
    function autoCalc() {
        const targetDensity = document.getElementById('densityNum').value;
        const measInput = document.getElementById('measuredVal').value;
        const truthInput = document.getElementById('trueVal').value;
        const meas = parseFloat(measInput);
        const truth = parseFloat(truthInput);

        if (rawData.length === 0 || selectedEnergies.size === 0) {
            document.getElementById('init-view').style.display = 'block';
            document.getElementById('result-view').style.display = 'none';
            return;
        }

        const header = rawData[1].map(h => String(h).trim());
        const colIdx = header.indexOf(String(targetDensity));
        
        if (colIdx === -1) {
            document.getElementById('res-cd').innerText = "N/A";
            return;
        }

        const selectedRows = rawData.slice(2).filter(r => 
            String(r[idxIsotope]).trim() === document.getElementById('isotopeSelect').value && 
            selectedEnergies.has(r[idxEnergy])
        );

        const sumW = selectedRows.reduce((s, r) => s + parseFloat(r[idxYield] || 0), 0);
        let cd = 0;
        selectedRows.forEach(r => {
            cd += parseFloat(r[colIdx] || 0) * (parseFloat(r[idxYield]) / sumW);
        });

        document.getElementById('init-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'block';
        document.getElementById('res-cd').innerText = cd.toFixed(6);

        const actEl = document.getElementById('res-activity').parentElement;
        const errEl = document.getElementById('res-error').parentElement;

        if (!isNaN(meas)) {
            const corrAct = meas / cd;
            document.getElementById('res-activity').innerText = corrAct.toFixed(2) + " Bq/kg";
            document.getElementById('res-activity').style.opacity = "1";
            if (!isNaN(truth) && truth !== 0) {
                const error = ((corrAct - truth) / truth) * 100;
                document.getElementById('res-error').innerText = error.toFixed(2) + "%";
                document.getElementById('res-error').style.color = Math.abs(error) > 20 ? "#ff5252" : "#00e676";
                errEl.style.opacity = "1";
            } else {
                document.getElementById('res-error').innerText = "--";
                errEl.style.opacity = "0.3";
            }
        } else {
            document.getElementById('res-activity').innerText = "Waiting for Input...";
            document.getElementById('res-activity').style.opacity = "0.3";
            errEl.style.opacity = "0.3";
        }
    }
</script>
</body>
</html>
