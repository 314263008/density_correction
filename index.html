<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Density Correction Center</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #5c5be5; --bg: #f0f2f9; --card: #ffffff; --dark-card: #121625; }
        body { font-family: 'Segoe UI', "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        header { background: var(--primary); color: white; padding: 20px 60px; display: flex; justify-content: space-between; align-items: center; }
        .logo-box { display: flex; align-items: center; gap: 15px; }
        .logo-icon { background: rgba(255,255,255,0.2); padding: 10px; border-radius: 12px; font-size: 24px; }

        main { display: grid; grid-template-columns: 1fr 380px; gap: 30px; padding: 40px; max-width: 1300px; margin: auto; width: 100%; box-sizing: border-box; }
        .card { background: var(--card); border-radius: 16px; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .card-title { color: var(--primary); font-weight: bold; margin-bottom: 25px; display: flex; align-items: center; gap: 10px; font-size: 18px; }

        label { display: block; font-size: 13px; font-weight: 600; color: #666; margin-bottom: 8px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; background: #fcfcfc; box-sizing: border-box; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }

        /* ËÉΩÈáèÈÅ∏ÊìáÂçÄÂüüÊ®£Âºè */
        .energy-options-container { 
            display: flex; flex-wrap: wrap; gap: 10px; 
            padding: 15px; border: 1px solid #eee; border-radius: 10px; background: #fafafa; min-height: 50px;
        }
        .energy-pill {
            display: flex; align-items: center; gap: 6px;
            padding: 8px 12px; background: white; border: 1px solid #ddd;
            border-radius: 20px; font-size: 13px; cursor: pointer; transition: 0.2s;
        }
        .energy-pill:hover { border-color: var(--primary); color: var(--primary); }
        .energy-pill.active { background: var(--primary); color: white; border-color: var(--primary); }
        .yield-text { font-size: 11px; opacity: 0.7; }

        /* ÊªëÊ°øËàáÁµêÊûúÈ°ØÁ§∫ (ÂêåÂâçÊ¨°Ë®≠Ë®à) */
        .slider-box { background: #f8faff; padding: 20px; border-radius: 12px; margin-bottom: 25px; }
        .summary-card { background: var(--dark-card); color: white; border-radius: 24px; padding: 40px 30px; display: flex; flex-direction: column; gap: 35px; min-height: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .val-large { font-size: 48px; font-weight: 600; font-family: 'Courier New', monospace; }
        .val-medium { font-size: 32px; font-weight: bold; color: #00e676; }
        .error-container { background: rgba(255,255,255,0.05); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); position: relative; }
        .error-val { font-size: 24px; font-weight: bold; color: #ff5252; }
        
        .btn-calc { background: var(--primary); color: white; border: none; padding: 18px; border-radius: 12px; width: 100%; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        #file-drop { border: 2px dashed #cbd5e1; padding: 25px; border-radius: 16px; text-align: center; background: white; margin-bottom: 25px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo-box">
        <div class="logo-icon">üß™</div>
        <div>
            <div style="font-size: 22px; font-weight: bold;">Density Correction Center</div>
            <div style="font-size: 12px; opacity: 0.8;">Gamma Spectroscopy Correction</div>
        </div>
    </div>
    <div style="text-align: right;">
        <div style="font-size: 20px; font-weight: bold;">œÅ = 1.0 g/cm¬≥</div>
    </div>
</header>

<main>
    <div class="left-col">
        <div id="file-drop" onclick="document.getElementById('fileInput').click()">
            <span id="file-name" style="color: #64748b;">Click to upload Excel (Required: "Â∑•‰ΩúË°®1")</span>
            <input type="file" id="fileInput" accept=".xlsx" style="display: none;">
        </div>

        <div class="card">
            <div class="card-title">‚öôÔ∏è Primary Parameters</div>
            <div class="slider-box">
    <div class="slider-info">
        <label>Sample Density (g/cm¬≥)</label>
        <input type="number" id="densityNum" value="0.3" min="0.3" max="2.2" step="0.1" 
               oninput="syncSlider(this.value)" 
               onblur="validateDensity(this.value)"
               style="width: 75px; border: 1px solid #ddd; border-radius: 6px; padding: 4px 8px; font-size: 16px; font-weight: bold; color: var(--primary); text-align: center;">
    </div>
    <input type="range" id="densitySlider" min="0.3" max="2.2" step="0.1" value="0.3" 
           oninput="syncInput(this.value)" style="width: 100%;">
    <div style="display: flex; justify-content: space-between; font-size: 11px; color: #94a3b8; font-weight: bold; margin-top: 8px;">
        <span>0.3 MIN</span>
        <span>1.0 STD</span>
        <span>2.2 MAX</span>
    </div>
</div>

            <div class="form-row">
                <div>
                    <label>Select Isotope (Ê†∏Á®Æ)</label>
                    <select id="isotopeSelect" onchange="updateEnergyOptions()">
                        <option>Wait for file...</option>
                    </select>
                </div>
                <div>
                    <label>Selected Gamma Energies (keV)</label>
                    <div id="energyOptions" class="energy-options-container">
                        <span style="color:#aaa; font-size:12px;">Choose isotope first...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title">üìä Validation & Analysis</div>
            <div class="form-row">
                <div><label>Measured Activity</label><input type="number" id="measuredVal" placeholder="e.g. 125.4"></div>
                <div><label>Ground Truth</label><input type="number" id="trueVal" placeholder="e.g. 120.0"></div>
            </div>
            <button class="btn-calc" onclick="calculate()">Run Correction Analysis</button>
        </div>
    </div>

    <div class="right-col">
        <div class="summary-card">
            <div id="init-view" style="text-align:center; margin-top:80px; color:#8e94aa;">Select parameters to begin</div>
            <div id="result-view" style="display: none;">
                <div class="sum-label">Weighted Factor (C<sub>d</sub>)</div>
                <div class="val-large" id="res-cd">1.000000</div>
                <div style="margin: 30px 0; border-top: 1px solid rgba(255,255,255,0.1);"></div>
                <div class="sum-label">Corrected Activity</div>
                <div class="val-medium" id="res-activity">0.00</div>
                <div class="error-container" style="margin-top: 40px;">
                    <div class="sum-label">Percentage Error</div>
                    <div class="error-val" id="res-error">0.00%</div>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    let rawData = [];
    let selectedEnergies = new Set();
    const slider = document.getElementById('densitySlider');
    const numInput = document.getElementById('densityNum');

    // Áï∂ÊªëÊ°øÁßªÂãïÊôÇÔºåÂêåÊ≠•Êõ¥Êñ∞Êï∏Â≠óÊ°Ü
    function syncInput(val) {
        numInput.value = val;
    }

    // Áï∂Êï∏Â≠óÊ°ÜËº∏ÂÖ•ÊôÇÔºåÂêåÊ≠•ÁßªÂãïÊªëÊ°ø
    function syncSlider(val) {
        // Âè™ÊúâÁï∂Ëº∏ÂÖ•ÊòØÊúâÊïàÊï∏Â≠ó‰∏îÂú®ÁØÑÂúçÂÖßÊôÇÊâçÁßªÂãïÊªëÊ°ø
        if (val !== "" && val >= 0.3 && val <= 2.2) {
            slider.value = val;
        }
    }

    // Áï∂Êï∏Â≠óÊ°ÜÂ§±ÂéªÁÑ¶Èªû (Blur) ÊàñÊåâ‰∏ã Enter ÊôÇÔºåÂº∑Âà∂‰øÆÊ≠£Ê∫¢Âá∫Êï∏ÂÄº
    function validateDensity(val) {
        let n = parseFloat(val);
        if (isNaN(n) || n < 0.3) {
            n = 0.3;
        } else if (n > 2.2) {
            n = 2.2;
        }
        // ‰øÆÊ≠£ÁÇ∫Â∞èÊï∏ÈªûÂæå‰∏Ä‰Ωç
        n = Math.round(n * 10) / 10;
        
        numInput.value = n;
        slider.value = n;
    }

    document.getElementById('fileInput').onchange = (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (event) => {
            const workbook = XLSX.read(new Uint8Array(event.target.result), {type: 'array'});
            const sheet = workbook.Sheets["Â∑•‰ΩúË°®1"];
            if(!sheet) return alert("Êâæ‰∏çÂà∞ 'Â∑•‰ΩúË°®1'");
            rawData = XLSX.utils.sheet_to_json(sheet, {header: 1});
            
            const isotopes = [...new Set(rawData.slice(2).map(r => r[2]))].filter(Boolean);
            document.getElementById('isotopeSelect').innerHTML = isotopes.map(i => `<option value="${i}">${i}</option>`).join('');
            updateEnergyOptions();
        };
        reader.readAsArrayBuffer(file);
    };

    // ÂãïÊÖãÊõ¥Êñ∞ËÉΩÈáèÊåâÈàï
    function updateEnergyOptions() {
        const iso = document.getElementById('isotopeSelect').value;
        const container = document.getElementById('energyOptions');
        selectedEnergies.clear();
        
        // ÁØ©ÈÅ∏Âá∫Ë©≤Ê†∏Á®ÆÁöÑÊâÄÊúâËÉΩÈáèËàáÊ¨äÈáç (Á¥¢Âºï 0 ÁÇ∫ËÉΩÈáè, Á¥¢Âºï 1 ÁÇ∫Ê¨äÈáç)
        const options = rawData.slice(2).filter(r => String(r[2]).trim() === iso);
        
        container.innerHTML = options.map(r => {
            const energy = r[0];
            const yieldVal = (parseFloat(r[1]) * 100).toFixed(1);
            return `<div class="energy-pill" onclick="toggleEnergy(this, ${energy})">
                        ${energy} <span class="yield-text">(${yieldVal}%)</span>
                    </div>`;
        }).join('');
    }

    function toggleEnergy(el, energy) {
        if(selectedEnergies.has(energy)) {
            selectedEnergies.delete(energy);
            el.classList.remove('active');
        } else {
            selectedEnergies.add(energy);
            el.classList.add('active');
        }
    }

    function calculate() {
        if(selectedEnergies.size === 0) return alert("Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãËÉΩÈáèÈ†ÖÁõÆ");
        
        const targetDensity = document.getElementById('densityNum').value.trim();
        const header = rawData[1].map(h => String(h).trim());
        const colIdx = header.indexOf(targetDensity);
        const meas = parseFloat(document.getElementById('measuredVal').value);
        const truth = parseFloat(document.getElementById('trueVal').value);

        // ÁØ©ÈÅ∏ÈÅ∏‰∏≠ÁöÑËÉΩÈáèÂàó
        const selectedRows = rawData.slice(2).filter(r => 
            String(r[2]).trim() === document.getElementById('isotopeSelect').value && 
            selectedEnergies.has(r[0])
        );

        const sumW = selectedRows.reduce((s, r) => s + parseFloat(r[1] || 0), 0);
        let cd = 0;
        selectedRows.forEach(r => {
            cd += parseFloat(r[colIdx] || 0) * (parseFloat(r[1]) / sumW);
        });

        const corrAct = meas / cd;
        const error = ((corrAct - truth) / truth) * 100;

        document.getElementById('init-view').style.display = 'none';
        document.getElementById('result-view').style.display = 'block';
        document.getElementById('res-cd').innerText = cd.toFixed(6);
        document.getElementById('res-activity').innerText = corrAct.toFixed(2) + " Bq/kg";
        document.getElementById('res-error').innerText = error.toFixed(2) + "%";
        document.getElementById('res-error').style.color = Math.abs(error) > 20 ? "#ff5252" : "#00e676";
    }
</script>
</body>
</html>
